<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 30px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.loading {
            background: #FFF3CD;
            color: #856404;
        }
        .status.success {
            background: #D4EDDA;
            color: #155724;
        }
        .status.error {
            background: #F8D7DA;
            color: #721C24;
        }
        .data-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .info-box {
            background: #E7F3FF;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge.admin {
            background: #FFF3E0;
            color: #E65100;
        }
        .badge.member {
            background: #E3F2FD;
            color: #1565C0;
        }
        .badge.active {
            background: #E8F5E9;
            color: #2E7D32;
        }
        .badge.pending {
            background: #FFF3E0;
            color: #F57C00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Firestore - Multi-User System</h1>
        
        <div class="info-box">
            <strong>üìå ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong><br>
            1. ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Browser (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ô dev server)<br>
            2. Login ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö<br>
            3. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </div>

        <div id="auth-status" class="status loading">
            ‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£ Login...
        </div>

        <div id="user-info"></div>

        <div id="controls" style="display: none;">
            <h2>üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h2>
            <button onclick="testGetCompanies()">üìã ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</button>
            <button onclick="testGetMembers()">üë• ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
            <button onclick="testCheckAdmin()">üëë ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin</button>
            <button onclick="clearResults()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</button>
        </div>

        <div id="results"></div>
    </div>

    <!-- Import Firebase ‡πÅ‡∏•‡∏∞ Services -->
    <script type="module">
        import { auth, db } from './firebase.config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { collection, getDocs, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        let currentUser = null;

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login
        onAuthStateChanged(auth, (user) => {
            const authStatus = document.getElementById('auth-status');
            const userInfo = document.getElementById('user-info');
            const controls = document.getElementById('controls');

            if (user) {
                currentUser = user;
                authStatus.className = 'status success';
                authStatus.innerHTML = '‚úÖ Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
                
                userInfo.innerHTML = `
                    <h2>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
                    <div class="data-box">
User ID: ${user.uid}
Email: ${user.email}
Display Name: ${user.displayName || '-'}
Phone: ${user.phoneNumber || '-'}
                    </div>
                `;
                
                controls.style.display = 'block';
            } else {
                authStatus.className = 'status error';
                authStatus.innerHTML = '‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ Login - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                userInfo.innerHTML = '';
                controls.style.display = 'none';
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
        window.testGetCompanies = async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó...</div>';

            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å memberships
                const membershipsQuery = query(
                    collection(db, 'companyMembers'),
                    where('userId', '==', currentUser.uid),
                    where('status', '==', 'active'),
                    orderBy('createdAt', 'desc')
                );
                const membershipsSnapshot = await getDocs(membershipsQuery);
                
                console.log('Memberships:', membershipsSnapshot.docs.length);

                const companies = [];
                for (const doc of membershipsSnapshot.docs) {
                    const memberData = doc.data();
                    console.log('Member Data:', memberData);
                    
                    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                    const companyQuery = query(
                        collection(db, 'companies'),
                        where('__name__', '==', memberData.companyId)
                    );
                    const companySnapshot = await getDocs(companyQuery);
                    
                    if (!companySnapshot.empty) {
                        const companyData = companySnapshot.docs[0].data();
                        companies.push({
                            id: companySnapshot.docs[0].id,
                            ...companyData,
                            memberRole: memberData.role
                        });
                    }
                }

                // 2. Fallback: ‡∏î‡∏∂‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                const oldCompaniesQuery = query(
                    collection(db, 'companies'),
                    where('userId', '==', currentUser.uid),
                    orderBy('createdAt', 'desc')
                );
                const oldCompaniesSnapshot = await getDocs(oldCompaniesQuery);
                
                oldCompaniesSnapshot.docs.forEach(doc => {
                    if (!companies.find(c => c.id === doc.id)) {
                        companies.push({
                            id: doc.id,
                            ...doc.data(),
                            memberRole: 'owner'
                        });
                    }
                });

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                if (companies.length === 0) {
                    results.innerHTML = `
                        <div class="status error">
                            ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏î‡πÜ<br>
                            <small>‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£</small>
                        </div>
                    `;
                } else {
                    let html = `
                        <div class="status success">
                            ‚úÖ ‡∏û‡∏ö ${companies.length} ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                        </div>
                        <h2>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</th>
                                    <th>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
                                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</th>
                                    <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    companies.forEach(company => {
                        const roleClass = company.memberRole === 'admin' || company.memberRole === 'owner' ? 'admin' : 'member';
                        const roleText = company.memberRole === 'owner' ? 'üëë Owner' : 
                                       company.memberRole === 'admin' ? 'üëë Admin' : 'üë§ Member';
                        
                        html += `
                            <tr>
                                <td><strong>${company.name}</strong></td>
                                <td>${company.address || '-'}</td>
                                <td>${company.memberCount || 0} ‡∏Ñ‡∏ô</td>
                                <td><span class="badge ${roleClass}">${roleText}</span></td>
                                <td>${company.createdAt ? new Date(company.createdAt.seconds * 1000).toLocaleDateString('th-TH') : '-'}</td>
                            </tr>
                        `;
                    });

                    html += `
                            </tbody>
                        </table>
                        <h3>üìÑ Raw Data</h3>
                        <div class="data-box">${JSON.stringify(companies, null, 2)}</div>
                    `;

                    results.innerHTML = html;
                }
            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}
                    </div>
                    <div class="data-box">${error.stack}</div>
                `;
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        window.testGetMembers = async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...</div>';

            try {
                // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Å‡πà‡∏≠‡∏ô
                const companiesQuery = query(
                    collection(db, 'companies'),
                    where('userId', '==', currentUser.uid)
                );
                const companiesSnapshot = await getDocs(companiesQuery);

                if (companiesSnapshot.empty) {
                    results.innerHTML = `
                        <div class="status error">
                            ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á<br>
                            <small>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö "‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" ‡∏Å‡πà‡∏≠‡∏ô</small>
                        </div>
                    `;
                    return;
                }

                const companyId = companiesSnapshot.docs[0].id;
                const companyName = companiesSnapshot.docs[0].data().name;

                // ‡∏î‡∏∂‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                const membersQuery = query(
                    collection(db, 'companyMembers'),
                    where('companyId', '==', companyId),
                    orderBy('createdAt', 'desc')
                );
                const membersSnapshot = await getDocs(membersQuery);

                let html = `
                    <div class="status success">
                        ‚úÖ ‡∏û‡∏ö ${membersSnapshot.docs.length} ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó "${companyName}"
                    </div>
                    <h2>üë• ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠</th>
                                <th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                membersSnapshot.docs.forEach(doc => {
                    const member = doc.data();
                    const roleClass = member.role === 'admin' ? 'admin' : 'member';
                    const roleText = member.role === 'admin' ? 'üëë Admin' : 'üë§ Member';
                    const statusClass = member.status;
                    const statusText = member.status === 'active' ? '‚úÖ Active' : 
                                     member.status === 'pending' ? '‚è≥ Pending' : '‚ùå Inactive';

                    html += `
                        <tr>
                            <td>${member.email}</td>
                            <td>${member.displayName || '-'}</td>
                            <td><span class="badge ${roleClass}">${roleText}</span></td>
                            <td><span class="badge ${statusClass}">${statusText}</span></td>
                            <td>${member.joinedAt ? new Date(member.joinedAt.seconds * 1000).toLocaleDateString('th-TH') : '-'}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                    <h3>üìÑ Raw Data</h3>
                    <div class="data-box">${JSON.stringify(membersSnapshot.docs.map(d => ({id: d.id, ...d.data()})), null, 2)}</div>
                `;

                results.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}
                    </div>
                    <div class="data-box">${error.stack}</div>
                `;
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
        window.testCheckAdmin = async () => {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="status loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå...</div>';

            try {
                // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
                const companiesQuery = query(
                    collection(db, 'companies'),
                    where('userId', '==', currentUser.uid)
                );
                const companiesSnapshot = await getDocs(companiesQuery);

                if (companiesSnapshot.empty) {
                    results.innerHTML = `
                        <div class="status error">
                            ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
                        </div>
                    `;
                    return;
                }

                const companyId = companiesSnapshot.docs[0].id;
                const companyName = companiesSnapshot.docs[0].data().name;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin
                const adminQuery = query(
                    collection(db, 'companyMembers'),
                    where('companyId', '==', companyId),
                    where('userId', '==', currentUser.uid),
                    where('role', '==', 'admin'),
                    where('status', '==', 'active')
                );
                const adminSnapshot = await getDocs(adminQuery);

                const isAdmin = !adminSnapshot.empty;

                results.innerHTML = `
                    <div class="status ${isAdmin ? 'success' : 'error'}">
                        ${isAdmin ? '‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô Admin' : '‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin'} ‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó "${companyName}"
                    </div>
                    <h2>üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h2>
                    <div class="data-box">
Company ID: ${companyId}
Company Name: ${companyName}
User ID: ${currentUser.uid}
Is Admin: ${isAdmin}
Admin Documents Found: ${adminSnapshot.docs.length}
                    </div>
                `;

                if (adminSnapshot.docs.length > 0) {
                    results.innerHTML += `
                        <h3>üìÑ Admin Document</h3>
                        <div class="data-box">${JSON.stringify(adminSnapshot.docs[0].data(), null, 2)}</div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                results.innerHTML = `
                    <div class="status error">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}
                    </div>
                    <div class="data-box">${error.stack}</div>
                `;
            }
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
        window.clearResults = () => {
            document.getElementById('results').innerHTML = '';
        };
    </script>
</body>
</html>

