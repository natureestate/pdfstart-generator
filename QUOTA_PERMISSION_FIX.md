# üîß ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "Missing or insufficient permissions" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Quota

## üìã ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤

‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `companyQuotas` ‡πÅ‡∏ï‡πà Firestore Rules ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:

1. **‡πÑ‡∏°‡πà‡∏°‡∏µ `companyMembers` document** - User ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ document ‡πÉ‡∏ô `companyMembers` collection
2. **Rules ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ `companyMembers`** - ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

## ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Firestore Rules

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏î‡πâ‡∏ß‡∏¢:

```javascript
// Company Quotas (‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó)
match /companyQuotas/{companyId} {
  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤:
  // 1. ‡πÄ‡∏õ‡πá‡∏ô Super Admin
  // 2. ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏°‡∏µ companyMembers document)
  // 3. ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (userId ‡πÉ‡∏ô companies collection ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)
  allow read: if isAuthenticated() && (
    isSuperAdmin() ||
    isMemberOfCompany(companyId) ||
    exists(/databases/$(database)/documents/companies/$(companyId)) &&
    get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
  );
  
  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÉ‡∏´‡∏°‡πà
  allow create: if isAuthenticated();
  
  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin
  allow update: if isAuthenticated() && isSuperAdmin();
  
  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin
  allow delete: if isAuthenticated() && isSuperAdmin();
}
```

### 2. Deploy Firestore Rules

```bash
firebase deploy --only firestore:rules
```

### 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Quota ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ

‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå `scripts/create-quota-for-company.html` ‡πÉ‡∏ô browser:

1. **Login** ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ account ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
2. ‡∏Ñ‡∏•‡∏¥‡∏Å **"‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó"** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
3. **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó** ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á quota
4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å **‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô** (Free, Basic, Premium, Enterprise)
5. ‡∏Ñ‡∏•‡∏¥‡∏Å **"‡∏™‡∏£‡πâ‡∏≤‡∏á Quota"**

‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ script ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:

```bash
cd scripts
npx ts-node create-default-quotas.ts
```

## üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à

1. ‡πÄ‡∏õ‡∏¥‡∏î Console ‡πÉ‡∏ô browser (F12)
2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ error `Missing or insufficient permissions` ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• quota ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥

## üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### Collection: `companyQuotas`

Document ID = Company ID

```typescript
{
  plan: 'free' | 'basic' | 'premium' | 'enterprise',
  status: 'active' | 'expired' | 'suspended' | 'trial',
  
  // ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  maxUsers: number,        // -1 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
  currentUsers: number,
  
  // ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
  maxDocuments: number,    // -1 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
  currentDocuments: number,
  documentResetDate: Timestamp,
  
  // ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤‡πÇ‡∏•‡πÇ‡∏Å‡πâ
  maxLogos: number,        // -1 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
  currentLogos: number,
  allowCustomLogo: boolean,
  
  // ‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ Storage
  maxStorageMB: number,    // -1 = ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
  currentStorageMB: number,
  
  // Features
  features: {
    multipleProfiles: boolean,
    apiAccess: boolean,
    customDomain: boolean,
    prioritySupport: boolean,
    exportPDF: boolean,
    exportExcel: boolean,
    advancedReports: boolean,
    customTemplates: boolean,
  },
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
  startDate: Timestamp,
  endDate?: Timestamp,
  trialEndDate?: Timestamp,
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
  lastPaymentDate?: Timestamp,
  nextPaymentDate?: Timestamp,
  paymentAmount?: number,
  currency?: string,
  
  // Metadata
  createdAt: Timestamp,
  updatedAt: Timestamp,
  updatedBy?: string,
  notes?: string,
}
```

## üéØ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### Free Plan
- üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: 3 ‡∏Ñ‡∏ô
- üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: 50 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- üñºÔ∏è ‡πÇ‡∏•‡πÇ‡∏Å‡πâ: 1 ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (‡πÉ‡∏ä‡πâ default ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
- üíæ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: 100 MB
- ‚úÖ Export PDF

### Basic Plan
- üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: 10 ‡∏Ñ‡∏ô
- üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: 200 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- üñºÔ∏è ‡πÇ‡∏•‡πÇ‡∏Å‡πâ: 3 ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (custom ‡πÑ‡∏î‡πâ)
- üíæ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: 500 MB
- ‚úÖ Export PDF, Excel
- ‚úÖ Custom Templates

### Premium Plan
- üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: 50 ‡∏Ñ‡∏ô
- üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: 1,000 ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- üñºÔ∏è ‡πÇ‡∏•‡πÇ‡∏Å‡πâ: 10 ‡πÇ‡∏•‡πÇ‡∏Å‡πâ (custom ‡πÑ‡∏î‡πâ)
- üíæ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: 2 GB
- ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
- ‚úÖ API Access
- ‚úÖ Priority Support

### Enterprise Plan
- üë• ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
- üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
- üñºÔ∏è ‡πÇ‡∏•‡πÇ‡∏Å‡πâ: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
- üíæ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà: ‡πÑ‡∏°‡πà‡∏à‡∏≥‡∏Å‡∏±‡∏î
- ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
- ‚úÖ Custom Domain

## üö® ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

1. **‡∏ï‡πâ‡∏≠‡∏á deploy Firestore Rules** ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ
2. **‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ quota** ‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
3. **Document ID ‡∏Ç‡∏≠‡∏á quota** ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Company ID
4. **currentDocuments ‡∏à‡∏∞ reset** ‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏° `documentResetDate`

## üîó ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

- [DYNAMIC_PLAN_GUIDE.md](./DYNAMIC_PLAN_GUIDE.md) - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
- [QUOTA_MIGRATION_GUIDE.md](./QUOTA_MIGRATION_GUIDE.md) - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ migrate quota
- [SUPER_ADMIN_GUIDE.md](./SUPER_ADMIN_GUIDE.md) - ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ Super Admin

## ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ

‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "Missing or insufficient permissions" ‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å:
- Firestore Rules ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ user ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏≠‡πà‡∏≤‡∏ô quota ‡πÑ‡∏î‡πâ

‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
1. ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Firestore Rules ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
2. ‚úÖ Deploy rules ‡πÉ‡∏´‡∏°‡πà
3. ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á quota ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ

‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:
- ‚úÖ User ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• quota ‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
- ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ permission error ‡∏≠‡∏µ‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
- ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö

