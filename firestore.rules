rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ฟังก์ชันตรวจสอบว่าผู้ใช้ Login แล้วหรือยัง
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ฟังก์ชันตรวจสอบว่าเป็นเจ้าของเอกสารหรือไม่
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ฟังก์ชันตรวจสอบว่าเป็น Super Admin หรือไม่
    function isSuperAdmin() {
      // ตรวจสอบว่ามี document ใน superAdmins collection ที่ match กับ userId
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/superAdmins/$(request.auth.uid));
    }
    
    // ฟังก์ชันตรวจสอบว่าเป็นสมาชิกขององค์กรหรือไม่
    function isMemberOfCompany(companyId) {
      // ตรวจสอบว่ามี document ใน companyMembers ที่ตรงกับ userId และ companyId
      return exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid + '_' + companyId))
        || exists(/databases/$(database)/documents/companyMembers/$(companyId + '_' + request.auth.uid));
    }
    
    // ฟังก์ชันตรวจสอบว่าเป็น Admin ขององค์กรหรือไม่
    // หมายเหตุ: ใช้ได้เฉพาะใน list operations เท่านั้น
    function isAdminOfCompany(companyId) {
      // ตรวจสอบว่ามี document ใด ๆ ที่:
      // 1. userId ตรงกับ user ปัจจุบัน
      // 2. companyId ตรงกับที่ระบุ
      // 3. role เป็น admin
      // 4. status เป็น active
      return exists(/databases/$(database)/documents/companyMembers/$(request.auth.uid + '_' + companyId))
        || exists(/databases/$(database)/documents/companyMembers/$(companyId + '_' + request.auth.uid));
    }
    
    // ใบส่งมอบงาน (Delivery Notes) - รองรับ Multi-user และ Super Admin
    match /deliveryNotes/{documentId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน (ถ้ามี companyId) หรือเป็น Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // อนุญาตให้สร้างเอกสารใหม่ได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // อนุญาตให้แก้ไขและลบได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน หรือเป็น Super Admin
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // ใบรับประกันสินค้า (Warranty Cards) - รองรับ Multi-user และ Super Admin
    match /warrantyCards/{documentId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน (ถ้ามี companyId) หรือเป็น Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // อนุญาตให้สร้างเอกสารใหม่ได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // อนุญาตให้แก้ไขและลบได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน หรือเป็น Super Admin
      allow update, delete: if isAuthenticated() && (
        isSuperAdmin() ||
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Company Profiles (ข้อมูลบริษัทที่บันทึกไว้)
    match /companyProfiles/{profileId} {
      // อนุญาตให้อ่านได้เฉพาะผู้ที่ Login แล้วและเป็นเจ้าของ profile
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // อนุญาตให้สร้าง profile ใหม่ได้เฉพาะผู้ที่ Login แล้ว และต้องมี userId ตรงกับผู้ใช้
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // อนุญาตให้แก้ไขและลบได้เฉพาะเจ้าของ profile
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Companies (ข้อมูลบริษัทสำหรับระบบ Multi-Company)
    match /companies/{companyId} {
      // อนุญาตให้อ่านได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow read: if isAuthenticated();
      
      // อนุญาตให้สร้างบริษัทใหม่ได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // อนุญาตให้แก้ไขได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow update: if isAuthenticated();
      
      // อนุญาตให้ลบได้เฉพาะ Admin คนแรก (คนที่สร้างบริษัท) หรือเป็น Super Admin
      allow delete: if isAuthenticated() && (isSuperAdmin() || isOwner(resource.data.userId));
    }
    
    // Company Members (สมาชิกในองค์กร)
    match /companyMembers/{memberId} {
      // อนุญาตให้อ่านได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow read: if isAuthenticated();
      
      // อนุญาตให้สร้างได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow create: if isAuthenticated();
      
      // อนุญาตให้แก้ไขได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow update: if isAuthenticated();
      
      // อนุญาตให้ลบได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow delete: if isAuthenticated();
    }
    
    // Service Templates (Template สำหรับข้อมูลสินค้า/บริการ) - รองรับ Multi-user
    match /serviceTemplates/{templateId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน (ถ้ามี companyId)
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // อนุญาตให้สร้าง template ใหม่ได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // อนุญาตให้แก้ไขและลบได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน
      allow update, delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Customers (ข้อมูลลูกค้า) - Customer Management System
    match /customers/{customerId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน
      allow read: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // อนุญาตให้สร้างลูกค้าใหม่ได้เฉพาะผู้ที่ Login แล้ว และต้องมี companyId
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.companyId != null &&
        isMemberOfCompany(request.resource.data.companyId);
      
      // อนุญาตให้แก้ไขและลบได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน
      allow update, delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
    }
    
    // Document Numbers (เลขที่เอกสารอัตโนมัติ - Running Number) - รองรับ Multi-user
    match /documentNumbers/{counterId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน
      // รูปแบบ counterId: {companyId}_{prefix}_{date} หรือ {userId}_{prefix}_{date}
      allow read: if isAuthenticated() && (
        counterId.matches('^' + request.auth.uid + '_.*') ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // อนุญาตให้สร้าง counter ใหม่ได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated() && (
        (request.resource.data.userId == request.auth.uid && counterId.matches('^' + request.auth.uid + '_.*')) ||
        (request.resource.data.companyId != null && isMemberOfCompany(request.resource.data.companyId))
      );
      
      // อนุญาตให้แก้ไข counter ได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน
      allow update: if isAuthenticated() && (
        (counterId.matches('^' + request.auth.uid + '_.*') && resource.data.userId == request.auth.uid) ||
        (resource.data.companyId != null && isMemberOfCompany(resource.data.companyId))
      );
      
      // ไม่อนุญาตให้ลบ counter (เพื่อรักษาความสมบูรณ์ของข้อมูล)
      allow delete: if false;
    }
    
    // Invitations (คำเชิญเข้าองค์กร)
    match /invitations/{invitationId} {
      // อนุญาตให้อ่านได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow read: if isAuthenticated();
      
      // อนุญาตให้สร้างคำเชิญได้ถ้า Login แล้ว
      allow create: if isAuthenticated();
      
      // อนุญาตให้แก้ไขคำเชิญได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow update: if isAuthenticated();
      
      // อนุญาตให้ลบคำเชิญได้ถ้า Login แล้ว หรือเป็น Super Admin
      allow delete: if isAuthenticated();
    }
    
    // Mail (สำหรับ Firebase Email Extension)
    match /mail/{mailId} {
      // อนุญาตให้สร้างอีเมลได้เฉพาะผู้ที่ Login แล้ว
      allow create: if isAuthenticated();
      
      // อนุญาตให้อ่านได้เฉพาะผู้ที่สร้าง (สำหรับตรวจสอบสถานะ)
      allow read: if isAuthenticated();
      
      // ไม่อนุญาตให้แก้ไขหรือลบ (Email Extension จะจัดการเอง)
      allow update, delete: if false;
    }
    
    // Super Admins (ผู้ดูแลระดับสูงสุด)
    match /superAdmins/{adminId} {
      // อนุญาตให้อ่านได้เฉพาะผู้ที่ Login แล้ว (เพื่อให้ตรวจสอบสถานะได้)
      allow read: if isAuthenticated();
      
      // อนุญาตให้สร้างได้เฉพาะ Super Admin (จำกัดการสร้าง Super Admin ใหม่)
      // TODO: ควรจำกัดให้เข้มงวดขึ้นใน Production (เฉพาะ Super Admin เท่านั้น)
      allow create: if isAuthenticated();
      
      // อนุญาตให้แก้ไขได้เฉพาะ Super Admin
      allow update: if isAuthenticated() && (isSuperAdmin() || isOwner(resource.data.userId));
      
      // ไม่อนุญาตให้ลบ (ป้องกันการลบ Super Admin โดยไม่ตั้งใจ)
      allow delete: if false;
    }
    
    // Company Quotas (โควตาและแผนการใช้งานของบริษัท)
    match /companyQuotas/{companyId} {
      // อนุญาตให้อ่านได้ถ้าเป็นสมาชิกในองค์กรเดียวกัน หรือเป็น Super Admin
      allow read: if isAuthenticated() && (
        isSuperAdmin() ||
        isMemberOfCompany(companyId)
      );
      
      // อนุญาตให้สร้างได้เฉพาะ Super Admin หรือตอนสร้างบริษัทใหม่
      allow create: if isAuthenticated();
      
      // อนุญาตให้แก้ไขได้เฉพาะ Super Admin
      allow update: if isAuthenticated() && isSuperAdmin();
      
      // อนุญาตให้ลบได้เฉพาะ Super Admin
      allow delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // Plan Templates (Template แผนการใช้งาน - แก้ไขได้แบบ Dynamic)
    match /planTemplates/{planId} {
      // อนุญาตให้อ่านได้ทุกคนที่ Login แล้ว (เพื่อแสดงแผนการใช้งาน)
      allow read: if isAuthenticated();
      
      // อนุญาตให้สร้างได้เฉพาะ Super Admin
      allow create: if isAuthenticated() && isSuperAdmin();
      
      // อนุญาตให้แก้ไขได้เฉพาะ Super Admin
      allow update: if isAuthenticated() && isSuperAdmin();
      
      // อนุญาตให้ลบได้เฉพาะ Super Admin
      allow delete: if isAuthenticated() && isSuperAdmin();
    }
    
    // Default: ปฏิเสธทุก collection อื่นๆ
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
