rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // ฟังก์ชันตรวจสอบว่าผู้ใช้ Login แล้วหรือยัง
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // ฟังก์ชันตรวจสอบว่าไฟล์เป็นรูปภาพหรือไม่
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }
    
    // ฟังก์ชันตรวจสอบขนาดไฟล์ (ไม่เกิน 2MB)
    function isValidSize() {
      return request.resource.size < 2 * 1024 * 1024; // 2MB
    }
    
    // โลโก้ของผู้ใช้
    match /logos/{userId}/{fileName} {
      // อนุญาตให้อ่านได้ทุกคน (เพื่อให้แสดงโลโก้ใน PDF ได้)
      allow read: if true;
      
      // อนุญาตให้อัปโหลดได้เฉพาะเจ้าของ และต้องเป็นรูปภาพ ขนาดไม่เกิน 2MB
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId 
                    && isImage() 
                    && isValidSize();
      
      // อนุญาตให้ลบได้เฉพาะเจ้าของ
      allow delete: if isAuthenticated() && request.auth.uid == userId;
      
      // อนุญาตให้แก้ไข/เขียนทับได้เฉพาะเจ้าของ และต้องเป็นรูปภาพ ขนาดไม่เกิน 2MB
      allow update: if isAuthenticated() 
                    && request.auth.uid == userId 
                    && isImage() 
                    && isValidSize();
    }
    
    // Default: ปฏิเสธทุกอย่างอื่น
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
